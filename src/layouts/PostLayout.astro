---
import Layout from './Layout.astro';

// 1. MUDAN√áA AQUI: O Astro j√° passa a vari√°vel 'headings' automaticamente junto com o frontmatter!
const { frontmatter, headings } = Astro.props;

// Fun√ß√£o para formatar a data
const dataFormatada = new Date(frontmatter.date).toLocaleDateString('pt-BR', {
  timeZone: 'UTC',
});

// Filtramos os t√≠tulos para pegar apenas os H2 e H3 (assim o √≠ndice n√£o fica polu√≠do com t√≠tulos muito pequenos)
const indice = headings?.filter((heading) => heading.depth === 2 || heading.depth === 3) || [];
---

<Layout title={frontmatter.title}>
    <article class="prose lg:prose-xl mx-auto mt-10 p-4">
        {frontmatter.category && (
            <span class="block text-blue-600 font-bold text-sm mb-2 uppercase tracking-wide">
                {frontmatter.category}
            </span>
        )}

        <h1 class="text-blue-700 font-extrabold text-4xl mb-4">{frontmatter.title}</h1>
        
        <div class="flex items-center text-gray-500 text-sm mb-6 border-b border-slate-200 pb-4">
            <span class="mr-2">‚úçÔ∏è {frontmatter.author}</span>
            <span class="mx-2">‚Ä¢</span>
            <span>üìÖ {dataFormatada}</span>
        </div>

        {/* 2. MUDAN√áA AQUI: Renderiza√ß√£o do √çndice (Table of Contents) */}
        {indice.length > 0 && (
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 mb-10 not-prose">
                <h2 class="text-lg font-bold text-slate-900 mb-4">üìñ √çndice</h2>
                <ul class="space-y-3">
                    {indice.map((heading) => (
                        <li style={{ paddingLeft: `${(heading.depth - 2) * 1.5}rem` }}>
                            <a 
                                href={`#${heading.slug}`} 
                                class="text-blue-600 hover:underline hover:text-blue-800 text-sm font-medium transition-colors"
                            >
                                {heading.text}
                            </a>
                        </li>
                    ))}
                </ul>
            </div>
        )}

        <div class="text-gray-800 leading-relaxed relative">
            <slot />
        </div>

        {frontmatter.tags && (
            <div class="mt-12 pt-6 border-t border-slate-200">
                <div class="flex flex-wrap gap-2">
                    {frontmatter.tags.map((tag) => (
                        <span class="bg-slate-100 text-slate-600 text-sm font-medium px-3 py-1 rounded-full hover:bg-blue-50 hover:text-blue-600 transition-colors cursor-default">
                            #{tag}
                        </span>
                    ))}
                </div>
            </div>
        )}
    </article>
</Layout>

{/* 3. MUDAN√áA AQUI: Script para injetar o bot√£o de copiar nos blocos de c√≥digo */}
<script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
        // Encontra todos os blocos de c√≥digo na p√°gina
        const codeBlocks = document.querySelectorAll('pre');

        codeBlocks.forEach((pre) => {
            // Garante que o bloco tem posi√ß√£o relativa para ancorar o bot√£o
            pre.style.position = 'relative';

            // Cria o bot√£o
            const copyButton = document.createElement('button');
            copyButton.className = 'absolute top-3 right-3 bg-slate-700/50 hover:bg-slate-700 text-slate-300 text-xs px-3 py-1.5 rounded-lg transition-all backdrop-blur-sm border border-slate-600';
            copyButton.innerHTML = 'Copiar';

            // Adiciona a a√ß√£o de clique
            copyButton.addEventListener('click', async () => {
                // Pega o texto puro dentro do c√≥digo
                const code = pre.querySelector('code');
                const text = code ? code.innerText : pre.innerText;

                try {
                    await navigator.clipboard.writeText(text);
                    
                    // Feedback visual
                    copyButton.innerHTML = '‚úÖ Copiado!';
                    copyButton.classList.replace('text-slate-300', 'text-green-400');
                    copyButton.classList.replace('bg-slate-700/50', 'bg-slate-800');
                    
                    // Retorna ao estado normal ap√≥s 2 segundos
                    setTimeout(() => {
                        copyButton.innerHTML = 'Copiar';
                        copyButton.classList.replace('text-green-400', 'text-slate-300');
                        copyButton.classList.replace('bg-slate-800', 'bg-slate-700/50');
                    }, 2000);
                } catch (err) {
                    console.error('Falha ao copiar', err);
                }
            });

            // Adiciona o bot√£o dentro do <pre>
            pre.appendChild(copyButton);
        });
    });
</script>